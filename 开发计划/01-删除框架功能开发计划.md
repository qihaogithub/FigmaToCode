# 阶段1：删除 HTML、Flutter、SwiftUI、Compose 框架

## 概述

本计划将删除 FigmaToCode 插件中的 HTML、Flutter、SwiftUI、Compose 四个框架的导出功能，仅保留 Tailwind 框架。这是整个重构计划的第一步，为后续的优化和功能开发奠定基础。

## 执行顺序

**本阶段必须在其他所有阶段之前执行**，因为：
- UI 优化依赖于框架精简
- 图片资源上传（阶段5）专注于 Tailwind
- 删除其他框架可以简化代码结构

## 重要说明（计划修订）

本仓库当前代码在 `packages/types/src/types.ts` 仍保留多框架类型与设置（HTML/Flutter/SwiftUI/Compose），与本阶段目标不一致。

为降低风险并避免后续阶段反复返工，本阶段除了删除后端各框架实现外，还需要**同步完成类型清理与配置迁移策略设计**（见下文“配置迁移策略”）。

## 删除范围

### 1. 需删除的目录和文件（约 40 个文件）

#### packages/backend/src/html/ - 删除整个目录
- htmlDefaultBuilder.ts
- htmlMain.ts
- htmlTextBuilder.ts
- builderImpl/htmlAutoLayout.ts
- builderImpl/htmlBlend.ts
- builderImpl/htmlBorderRadius.ts
- builderImpl/htmlColor.ts
- builderImpl/htmlPadding.ts
- builderImpl/htmlShadow.ts
- builderImpl/htmlSize.ts

#### packages/backend/src/flutter/ - 删除整个目录
- flutterContainer.ts
- flutterDefaultBuilder.ts
- flutterMain.ts
- flutterTextBuilder.ts
- builderImpl/flutterAutoLayout.ts
- builderImpl/flutterBlend.ts
- builderImpl/flutterBorder.ts
- builderImpl/flutterColor.ts
- builderImpl/flutterPadding.ts
- builderImpl/flutterShadow.ts
- builderImpl/flutterSize.ts

#### packages/backend/src/swiftui/ - 删除整个目录
- swiftuiDefaultBuilder.ts
- swiftuiMain.ts
- swiftuiTextBuilder.ts
- builderImpl/swiftuiBlend.ts
- builderImpl/swiftuiBorder.ts
- builderImpl/swiftuiColor.ts
- builderImpl/swiftuiEffects.ts
- builderImpl/swiftuiPadding.ts
- builderImpl/swiftuiParser.ts
- builderImpl/swiftuiSize.ts
- builderImpl/swiftuiTextWeight.ts

#### packages/backend/src/compose/ - 删除整个目录
- composeContainer.ts
- composeDefaultBuilder.ts
- composeMain.ts
- composeTextBuilder.ts
- builderImpl/composeAutoLayout.ts
- builderImpl/composeBlend.ts
- builderImpl/composeBorder.ts
- builderImpl/composeColor.ts
- builderImpl/composePadding.ts
- builderImpl/composeShadow.ts
- builderImpl/composeSize.ts

### 2. 需修改的文件（12 个文件）

#### 类型定义修改

**文件：** `packages/types/src/types.ts`

本阶段的目标是“只保留 Tailwind”，因此类型层也必须同步收敛，否则后续阶段会被类型与历史配置拖累。

- 将 `Framework` 类型改为：`export type Framework = "Tailwind";`
- 删除 `HTMLSettings`、`FlutterSettings`、`SwiftUISettings`、`ComposeSettings` 接口
- 重构 `TailwindSettings`：**移除对 `HTMLSettings` 的继承**，把 Tailwind 实际需要的字段直接定义在 `TailwindSettings`
- 修改 `PluginSettings`：**只保留 Tailwind 所需字段**，不要再用“多框架 settings 叠加”的方式

**注意**：当前仓库 `TailwindSettings` 里存在与 `HTMLSettings` 重复的字段（例如 `embedVectors`、`useColorVariables`）。在移除继承后，需要明确“最终保留哪一个字段定义”，避免重复与类型冲突。

**修改示例（阶段1结束态）**：
```typescript
// 阶段1结束后（仅保留 Tailwind）
export type Framework = "Tailwind";

export interface TailwindSettings {
  // 代码生成模式（阶段2会进一步删除 twig）
  tailwindGenerationMode: "html" | "jsx" | "twig";

  // Tailwind 专属配置
  roundTailwindValues: boolean;
  roundTailwindColors: boolean;
  customTailwindPrefix?: string;
  baseFontSize: number;
  useTailwind4: boolean;
  thresholdPercent: number;
  baseFontFamily: string;
  fontFamilyCustomConfig: Record<string, string[]>;

  // 与导出/预览相关的通用配置（从 HTMLSettings 迁移而来）
  showLayerNames: boolean;
  embedImages: boolean;
  embedVectors: boolean;
  useColorVariables: boolean;
}

export interface PluginSettings extends TailwindSettings {
  framework: Framework;
  useOldPluginVersion2025: boolean;
  responsiveRoot: boolean;
}
```

#### 后端入口修改

**文件：** `packages/backend/src/index.ts`

- 删除 `flutterMain`、`htmlMain`、`swiftuiMain`、`composeMain` 的导出
- 只保留 `tailwindMain` 和 `run` 的导出

#### 代码转换路由修改

**文件：** `packages/backend/src/common/retrieveUI/convertToCode.ts`

- 修改 `convertToCode` 函数，移除 switch 语句，直接返回 `tailwindMain` 的结果
- 删除 `flutterMain`、`htmlMain`、`swiftuiMain`、`composeMain` 的导入

**修改示例：**
```typescript
// 修改前
export const convertToCode = async (
  sceneNode: Array<SceneNode>,
  settings: PluginSettings,
): Promise<string> => {
  switch (settings.framework) {
    case "HTML":
      return htmlMain(sceneNode, settings);
    case "Tailwind":
      return tailwindMain(sceneNode, settings);
    case "Flutter":
      return flutterMain(sceneNode, settings);
    case "SwiftUI":
      return swiftuiMain(sceneNode, settings);
    case "Compose":
      return composeMain(sceneNode, settings);
    default:
      return "";
  }
};

// 修改后
export const convertToCode = async (
  sceneNode: Array<SceneNode>,
  settings: PluginSettings,
): Promise<string> => {
  return tailwindMain(sceneNode, settings);
};
```

#### 颜色提取修改

**文件：** `packages/backend/src/common/retrieveUI/retrieveColors.ts`

- 删除 `retrieveGenericSolidUIColors` 和 `retrieveGenericLinearGradients` 函数中对 Flutter、HTML、SwiftUI、Compose 的条件判断
- 只保留 Tailwind 的颜色转换逻辑

#### 节点工具修改

**文件：** `packages/backend/src/altNodes/altNodeUtils.ts`

- 将 `import { htmlColor } from "../html/builderImpl/htmlColor";` 改为 `import { tailwindColor } from "../tailwind/builderImpl/tailwindColor";`
- 将 `htmlColor` 函数调用改为 `tailwindColor`

#### UI 主组件修改

**文件：** `packages/plugin-ui/src/PluginUI.tsx`

- 将 `const frameworks: Framework[] = ["HTML", "Tailwind", "Flutter", "SwiftUI"];` 改为 `const frameworks: Framework[] = ["Tailwind"];`

#### 配置选项修改

**文件：** `packages/plugin-ui/src/codegenPreferenceOptions.ts`

- 删除 `htmlGenerationMode` 相关选项
- 删除 `flutterGenerationMode` 相关选项
- 删除 `swiftUIGenerationMode` 相关选项
- 删除 `composeGenerationMode` 相关选项
- 保留 Tailwind 相关的所有选项

#### 代码面板修改

**文件：** `packages/plugin-ui/src/components/CodePanel.tsx`

- 简化语法高亮语言判断逻辑，只保留 HTML/JSX/Twig 的高亮
- 删除对 Flutter、SwiftUI、Compose 的语言判断

#### 关于页面修改

**文件：** `packages/plugin-ui/src/components/About.tsx`

- 将描述从 "Convert Figma designs to HTML, Tailwind, Flutter, and SwiftUI" 改为 "Convert Figma designs to Tailwind"

#### 插件入口修改

**文件：** `apps/plugin/plugin-src/code.ts`

- 删除 `flutterMain`、`htmlMain`、`swiftuiMain`、`composeMain` 的导入
- 修改 `defaultPluginSettings`，删除其他框架的默认设置
- 修改 `codegenMode` 函数，删除其他框架的 case 分支
- 将默认框架改为 "Tailwind"

#### 调试应用修改

**文件：** `apps/debug/app/page.tsx`

- 将默认框架状态改为 "Tailwind"

#### 插件配置修改

**文件：** `manifest.json`

- 将插件名称改为 "Figma to Code [Tailwind]"
- 将 `codegenLanguages` 数组改为：
  ```json
  "codegenLanguages": [
    { "label": "Tailwind", "value": "tailwind" },
    { "label": "Tailwind (JSX)", "value": "tailwind_jsx" }
  ]
  ```

## 配置迁移策略（必须补充）

本项目的插件设置通常会通过 `figma.clientStorage` 等方式被持久化。删除多框架后，历史配置中可能仍包含：
- `framework: "HTML" | "Flutter" | "SwiftUI" | "Compose"`
- 各框架 generationMode 字段

为避免升级后插件因为读取旧配置而报错，本阶段需要增加迁移策略：
- **框架强制迁移**：若旧配置里 `framework !== "Tailwind"`，启动时自动改为 `"Tailwind"`
- **冗余字段容错**：迁移时忽略旧配置中不再存在的字段（HTML/Flutter/SwiftUI/Compose 相关字段）
- **默认值补齐**：对 TailwindSettings 新增/调整的字段，按 `defaultPluginSettings` 补齐缺失值

迁移逻辑应放在“读取设置并合并默认值”的入口处（例如插件 code 端初始化 settings 的地方），而不是散落在各业务分支。

## 实施步骤

### 第一步：备份和准备

1. 创建 git 分支用于本次修改
2. 确认当前代码可以正常构建

```bash
git checkout -b feature/remove-frameworks
pnpm build
```

### 第二步：删除框架目录

```bash
# 删除 HTML 框架
rm -rf packages/backend/src/html/

# 删除 Flutter 框架
rm -rf packages/backend/src/flutter/

# 删除 SwiftUI 框架
rm -rf packages/backend/src/swiftui/

# 删除 Compose 框架
rm -rf packages/backend/src/compose/
```

### 第三步：修改类型定义

1. 修改 `packages/types/src/types.ts`
2. 运行 `pnpm lint` 检查类型错误

### 第四步：修改后端代码

1. 修改 `packages/backend/src/index.ts`
2. 修改 `packages/backend/src/common/retrieveUI/convertToCode.ts`
3. 修改 `packages/backend/src/common/retrieveUI/retrieveColors.ts`
4. 修改 `packages/backend/src/altNodes/altNodeUtils.ts`

### 第五步：修改 UI 组件

1. 修改 `packages/plugin-ui/src/PluginUI.tsx`
2. 修改 `packages/plugin-ui/src/codegenPreferenceOptions.ts`
3. 修改 `packages/plugin-ui/src/components/CodePanel.tsx`
4. 修改 `packages/plugin-ui/src/components/About.tsx`

### 第六步：修改插件配置

1. 修改 `apps/plugin/plugin-src/code.ts`
2. 修改 `apps/debug/app/page.tsx`
3. 修改 `manifest.json`

### 第七步：测试验证

1. 运行 `pnpm lint` 检查代码规范
2. 运行 `pnpm build` 构建项目
3. 在 Figma 中测试插件功能
4. 验证 Tailwind 导出功能正常工作

```bash
pnpm lint
pnpm build
```

## 风险评估

### 高风险

- `altNodeUtils.ts` 中的 `htmlColor` 依赖可能影响所有框架，需要确保替换为 `tailwindColor` 后功能正常

### 中风险

- `TailwindSettings` 继承自 `HTMLSettings`，删除 HTML 后需要确保所有必要属性都被正确迁移
- `retrieveColors.ts` 中的颜色转换逻辑需要仔细测试

### 低风险

- UI 组件的修改主要是删除选项，风险较低
- 配置文件的修改风险较低

## 预期结果

删除完成后，项目将：

- 只支持 Tailwind 框架的代码生成
- 减少约 40 个文件
- 简化代码结构，提高可维护性
- 减少构建时间和包体积

## 验证清单

- [ ] 所有框架目录已删除
- [ ] 类型定义已更新
- [ ] 后端代码已修改
- [ ] UI 组件已修改
- [ ] 插件配置已修改
- [ ] 编译无错误
- [ ] Lint 检查通过
- [ ] Tailwind 导出功能正常工作
- [ ] 插件在 Figma 中正常运行

## 时间估算

- 备份和准备：10 分钟
- 删除框架目录：5 分钟
- 修改类型定义：15 分钟
- 修改后端代码：30 分钟
- 修改 UI 组件：20 分钟
- 修改插件配置：15 分钟
- 测试验证：30 分钟
- **总计：约 2 小时**

## 后续步骤

完成本阶段后，可以继续执行：
- 阶段2：删除Twig功能
- 阶段3：删除Email和About功能
- 阶段4：UI优化（Preview和Code作为一级Tab）
- 阶段5：Tailwind位图和矢量图上传OSS功能

---

**文档版本**: 1.0
**创建日期**: 2026-01-14
**最后更新**: 2026-01-14